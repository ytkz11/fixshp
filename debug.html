<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•é¡µé¢ - Shapefileä¿®å¤å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .upload-area { border: 2px dashed #ccc; padding: 20px; margin: 20px 0; text-align: center; }
        .file-item { background: #f0f0f0; padding: 10px; margin: 5px 0; }
        button { padding: 10px 20px; margin: 10px 0; }
        .results { background: #e8f4fd; padding: 15px; margin: 20px 0; }
        .debug { background: #fff3cd; padding: 10px; margin: 10px 0; font-family: monospace; }
    </style>
</head>
<body>
    <h1>Shapefileä¿®å¤å·¥å…· - è°ƒè¯•ç‰ˆæœ¬</h1>
    
    <div class="debug" id="debugLog">è°ƒè¯•ä¿¡æ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
    
    <div class="upload-area" id="fileUpload">
        <p>ç‚¹å‡»è¿™é‡Œé€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
        <input type="file" id="fileInput" multiple accept=".shp,.dbf,.shx,.prj">
    </div>
    
    <div id="fileList"></div>
    
    <button id="processBtn" disabled>å¼€å§‹å¤„ç†æ–‡ä»¶</button>
    
    <div class="results" id="results" style="display: none;">
        <h3>å¤„ç†ç»“æœ</h3>
        <div id="resultContent"></div>
    </div>
    
    <div id="progressContainer" style="display: none;">
        <div id="progressBar" style="width: 0%; height: 20px; background: blue;"></div>
    </div>

    <script>
        // è°ƒè¯•æ—¥å¿—å‡½æ•°
        function debugLog(message) {
            const debugDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            debugDiv.innerHTML += `<br>[${timestamp}] ${message}`;
            console.log(`[DEBUG] ${message}`);
        }
        
        debugLog('é¡µé¢å¼€å§‹åŠ è½½...');
        
        // ç®€åŒ–çš„Shapefileå¤„ç†ç±»
        class SimpleShapefileRestorer {
            constructor() {
                debugLog('åˆ›å»ºSimpleShapefileRestorerå®ä¾‹');
                this.files = new Map();
                this.results = [];
                this.init();
            }
            
            init() {
                debugLog('å¼€å§‹åˆå§‹åŒ–...');
                
                const fileUpload = document.getElementById('fileUpload');
                const fileInput = document.getElementById('fileInput');
                const processBtn = document.getElementById('processBtn');
                
                if (!fileUpload || !fileInput || !processBtn) {
                    debugLog('é”™è¯¯ï¼šæ‰¾ä¸åˆ°å¿…è¦çš„DOMå…ƒç´ ');
                    return;
                }
                
                debugLog('DOMå…ƒç´ æ‰¾åˆ°ï¼Œç»‘å®šäº‹ä»¶...');
                
                // æ–‡ä»¶ä¸Šä¼ ç‚¹å‡»äº‹ä»¶
                fileUpload.addEventListener('click', () => {
                    debugLog('ä¸Šä¼ åŒºåŸŸè¢«ç‚¹å‡»');
                    fileInput.click();
                });
                
                // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
                fileInput.addEventListener('change', (e) => {
                    debugLog(`æ–‡ä»¶é€‰æ‹©äº‹ä»¶è§¦å‘ï¼Œæ–‡ä»¶æ•°é‡: ${e.target.files.length}`);
                    this.handleFiles(e.target.files);
                });
                
                // æ‹–æ‹½äº‹ä»¶
                fileUpload.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    debugLog('æ‹–æ‹½æ‚¬åœ');
                });
                
                fileUpload.addEventListener('drop', (e) => {
                    e.preventDefault();
                    debugLog(`æ–‡ä»¶æ‹–æ‹½æ”¾ä¸‹ï¼Œæ–‡ä»¶æ•°é‡: ${e.dataTransfer.files.length}`);
                    this.handleFiles(e.dataTransfer.files);
                });
                
                // å¤„ç†æŒ‰é’®äº‹ä»¶
                processBtn.addEventListener('click', () => {
                    debugLog('å¤„ç†æŒ‰é’®è¢«ç‚¹å‡»');
                    this.processFiles();
                });
                
                debugLog('äº‹ä»¶ç»‘å®šå®Œæˆ');
            }
            
            handleFiles(files) {
                debugLog(`å¼€å§‹å¤„ç† ${files.length} ä¸ªæ–‡ä»¶`);
                
                const fileList = document.getElementById('fileList');
                const processBtn = document.getElementById('processBtn');
                
                this.files.clear();
                fileList.innerHTML = '';
                
                Array.from(files).forEach(file => {
                    const extension = file.name.split('.').pop().toLowerCase();
                    debugLog(`å¤„ç†æ–‡ä»¶: ${file.name}, æ‰©å±•å: ${extension}`);
                    
                    if (['shp', 'dbf', 'shx', 'prj'].includes(extension)) {
                        this.files.set(extension, file);
                        this.addFileToList(file, extension);
                        debugLog(`æ–‡ä»¶ ${file.name} å·²æ·»åŠ åˆ°åˆ—è¡¨`);
                    } else {
                        debugLog(`æ–‡ä»¶ ${file.name} ä¸æ˜¯æ”¯æŒçš„æ ¼å¼`);
                    }
                });
                
                const hasShp = this.files.has('shp');
                const hasDbf = this.files.has('dbf');
                
                debugLog(`æ–‡ä»¶æ£€æŸ¥: SHP=${hasShp}, DBF=${hasDbf}`);
                
                processBtn.disabled = !(hasShp && hasDbf);
                
                if (hasShp && hasDbf) {
                    debugLog('æ–‡ä»¶æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å¼€å§‹å¤„ç†');
                } else {
                    debugLog('è­¦å‘Šï¼šéœ€è¦åŒæ—¶ä¸Šä¼ .shpå’Œ.dbfæ–‡ä»¶');
                }
            }
            
            addFileToList(file, extension) {
                const fileList = document.getElementById('fileList');
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `ğŸ“„ ${file.name} (${extension.toUpperCase()}) - ${this.formatFileSize(file.size)}`;
                fileList.appendChild(fileItem);
            }
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            async processFiles() {
                debugLog('å¼€å§‹å¤„ç†æ–‡ä»¶...');
                
                const processBtn = document.getElementById('processBtn');
                const results = document.getElementById('results');
                const resultContent = document.getElementById('resultContent');
                const progressContainer = document.getElementById('progressContainer');
                const progressBar = document.getElementById('progressBar');
                
                processBtn.disabled = true;
                processBtn.textContent = 'æ­£åœ¨å¤„ç†...';
                progressContainer.style.display = 'block';
                results.style.display = 'none';
                
                try {
                    // æ¨¡æ‹Ÿå¤„ç†æ­¥éª¤
                    for (let i = 1; i <= 5; i++) {
                        debugLog(`å¤„ç†æ­¥éª¤ ${i}/5`);
                        await this.delay(500);
                        progressBar.style.width = (i * 20) + '%';
                    }
                    
                    // æ¨¡æ‹Ÿç»“æœ
                    const shpRecords = Math.floor(Math.random() * 1000) + 100;
                    const dbfRecords = shpRecords + Math.floor(Math.random() * 21) - 10;
                    
                    debugLog(`æ¨¡æ‹Ÿç»“æœ: SHPè®°å½•=${shpRecords}, DBFè®°å½•=${dbfRecords}`);
                    
                    resultContent.innerHTML = `
                        <p>âœ… å¤„ç†å®Œæˆï¼</p>
                        <p>SHPæ–‡ä»¶è®°å½•æ•°: ${shpRecords}</p>
                        <p>DBFæ–‡ä»¶è®°å½•æ•°: ${dbfRecords}</p>
                        <p>å·®å¼‚: ${Math.abs(shpRecords - dbfRecords)} æ¡è®°å½•</p>
                        <p>${shpRecords === dbfRecords ? 'âœ… æ•°æ®ä¸€è‡´ï¼Œæ— éœ€ä¿®å¤' : 'âš ï¸ æ•°æ®ä¸ä¸€è‡´ï¼Œéœ€è¦ä¿®å¤'}</p>
                    `;
                    
                    results.style.display = 'block';
                    debugLog('å¤„ç†å®Œæˆï¼Œç»“æœå·²æ˜¾ç¤º');
                    
                } catch (error) {
                    debugLog(`å¤„ç†å‡ºé”™: ${error.message}`);
                } finally {
                    processBtn.disabled = false;
                    processBtn.textContent = 'å¼€å§‹å¤„ç†æ–‡ä»¶';
                    progressContainer.style.display = 'none';
                    progressBar.style.width = '0%';
                }
            }
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            debugLog('DOMåŠ è½½å®Œæˆ');
            try {
                const restorer = new SimpleShapefileRestorer();
                debugLog('åº”ç”¨åˆå§‹åŒ–æˆåŠŸ');
                window.restorer = restorer; // ä¾¿äºè°ƒè¯•
            } catch (error) {
                debugLog(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
            }
        });
        
        debugLog('è„šæœ¬åŠ è½½å®Œæˆ');
    </script>
</body>
</html>